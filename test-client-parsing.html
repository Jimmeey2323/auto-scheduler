<!DOCTYPE html>
<html>
<head>
    <title>Test Client-Side Parsing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Test Client-Side Parsing</h1>
    
    <div class="test-section">
        <h2>Test HTML Parsing (Kemps.html)</h2>
        <button onclick="testKempsHTML()">Parse Kemps.html</button>
    </div>
    
    <div class="test-section">
        <h2>Test HTML Parsing (Bandra.html)</h2>
        <button onclick="testBandraHTML()">Parse Bandra.html</button>
    </div>
    
    <div id="output"></div>

    <script>
        const DAYS = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY', 'SUNDAY'];
        
        const CLASS_ALIASES = {
            'STRENGTH LAB (PUSH)': ['STRENGTH LAB PUSH', 'SL PUSH', 'STRENGTH PUSH'],
            'STRENGTH LAB (PULL)': ['STRENGTH LAB PULL', 'SL PULL', 'STRENGTH PULL'],
            'STRENGTH LAB (FULL BODY)': ['STRENGTH LAB FULL BODY', 'SL FULL BODY', 'STRENGTH FULL BODY'],
            'CARDIO BARRE': ['CARDIOBARRE', 'CB'],
            'CARDIO BARRE PLUS': ['CARDIO BARRE+', 'CB PLUS', 'CB+'],
            'CARDIO BARRE EXPRESS': ['CARDIO BARRE EXP', 'CB EXPRESS', 'CB EXP'],
            'BARRE 57': ['BARRE57', 'B57'],
            'MAT 57': ['MAT57', 'M57'],
            'MAT 57 EXPRESS': ['MAT 57 EXP', 'MAT57 EXPRESS', 'M57 EXP'],
            'POWERCYCLE': ['POWER CYCLE', 'PC'],
            'AMPED UP!': ['AMPED UP', 'AMPED'],
            'FIT': ['FITNESS'],
        };

        function normalizeClassName(name) {
            if (!name) return '';
            let normalized = name.trim().toUpperCase();
            normalized = normalized.replace(/\s+/g, ' ');
            
            for (const [standard, aliases] of Object.entries(CLASS_ALIASES)) {
                if (normalized === standard || aliases.includes(normalized)) {
                    return standard;
                }
            }
            return normalized;
        }

        function normalizeTrainerName(name) {
            if (!name) return '';
            return name.trim().toUpperCase().replace(/\s+/g, ' ');
        }

        function normalizeTime(time) {
            if (!time) return '';
            time = time.trim().toUpperCase().replace(/\s+/g, ' ');
            
            const patterns = [
                /(\d{1,2}):(\d{2})\s*(AM|PM)/,
                /(\d{1,2})\.(\d{2})\s*(AM|PM)/,
                /(\d{1,2}):(\d{2})(AM|PM)/,
                /(\d{1,2})\s*(AM|PM)/,
            ];
            
            for (const pattern of patterns) {
                const match = time.match(pattern);
                if (match) {
                    if (match.length === 4) {
                        return `${parseInt(match[1])}:${match[2]} ${match[3]}`;
                    } else if (match.length === 3) {
                        return `${parseInt(match[1])}:00 ${match[2]}`;
                    }
                }
            }
            return time;
        }

        async function parseHTMLFile(filePath, location) {
            const response = await fetch(filePath);
            const html = await response.text();
            
            const data = {};
            data[location] = {};
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            let currentDay = null;
            let classCount = 0;
            
            const spans = Array.from(doc.querySelectorAll('span'));
            console.log(`[HTML ${location}] Total spans:`, spans.length);
            
            for (let index = 0; index < spans.length; index++) {
                const span = spans[index];
                const text = span.textContent.trim();
                
                // Check for day headers (look for exact day names)
                const dayMatch = DAYS.find(day => text.toUpperCase() === day || text.toUpperCase() === day + ' ');
                if (dayMatch) {
                    currentDay = dayMatch;
                    console.log(`[HTML ${location}] Found day:`, dayMatch);
                    continue;
                }
                
                if (!currentDay) continue;
                
                // Check for time entries - look for class s23 or s9 (time spans)
                const className = span.className || '';
                if (className.includes('s23') || className.includes('s9')) {
                    const timeMatch = text.match(/^(\d{1,2}:\d{2}\s*(?:AM|PM))$/i);
                    if (timeMatch) {
                        const time = normalizeTime(timeMatch[1]);
                        
                        // Look for class info in the VERY NEXT span
                        if (index + 1 < spans.length) {
                            const nextSpan = spans[index + 1];
                            const nextText = nextSpan.textContent.trim();
                            
                            // Check if it contains " - " separator
                            if (nextText.includes(' - ')) {
                                // Split by first " - " occurrence
                                const dashIndex = nextText.indexOf(' - ');
                                const classNameRaw = nextText.substring(0, dashIndex);
                                const trainerRaw = nextText.substring(dashIndex + 3);
                                
                                const normalizedClass = normalizeClassName(classNameRaw);
                                const normalizedTrainer = normalizeTrainerName(trainerRaw);
                                
                                if (normalizedClass && normalizedTrainer) {
                                    const key = `${location}|${currentDay}|${time}`;
                                    if (!data[location][key]) data[location][key] = [];
                                    
                                    data[location][key].push({
                                        day: currentDay,
                                        time,
                                        class: normalizedClass,
                                        trainer: normalizedTrainer
                                    });
                                    classCount++;
                                    console.log(`[HTML ${location}] ${currentDay} ${time}: ${normalizedClass} - ${normalizedTrainer}`);
                                }
                            }
                        }
                    }
                }
            }
            
            console.log(`[HTML ${location}] Parsed ${classCount} classes`);
            return data;
        }

        async function testKempsHTML() {
            const output = document.getElementById('output');
            output.textContent = 'Parsing Kemps.html...';
            
            try {
                const data = await parseHTMLFile('Kemps.html', 'KEMPS');
                const classCount = Object.keys(data.KEMPS || {}).length;
                
                let result = `✅ Successfully parsed Kemps.html\n`;
                result += `Found ${classCount} time slots\n\n`;
                
                // Show first 5 entries
                const entries = Object.entries(data.KEMPS || {}).slice(0, 5);
                result += 'Sample entries:\n';
                entries.forEach(([key, classes]) => {
                    const [location, day, time] = key.split('|');
                    classes.forEach(cls => {
                        result += `${day} ${time}: ${cls.class} - ${cls.trainer}\n`;
                    });
                });
                
                output.textContent = result;
                console.log('Kemps data:', data);
            } catch (error) {
                output.textContent = `❌ Error: ${error.message}`;
                console.error('Error:', error);
            }
        }

        async function testBandraHTML() {
            const output = document.getElementById('output');
            output.textContent = 'Parsing Bandra.html...';
            
            try {
                const data = await parseHTMLFile('Bandra.html', 'BANDRA');
                const classCount = Object.keys(data.BANDRA || {}).length;
                
                let result = `✅ Successfully parsed Bandra.html\n`;
                result += `Found ${classCount} time slots\n\n`;
                
                // Show first 5 entries
                const entries = Object.entries(data.BANDRA || {}).slice(0, 5);
                result += 'Sample entries:\n';
                entries.forEach(([key, classes]) => {
                    const [location, day, time] = key.split('|');
                    classes.forEach(cls => {
                        result += `${day} ${time}: ${cls.class} - ${cls.trainer}\n`;
                    });
                });
                
                output.textContent = result;
                console.log('Bandra data:', data);
            } catch (error) {
                output.textContent = `❌ Error: ${error.message}`;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
